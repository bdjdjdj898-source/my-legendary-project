# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

## –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- ‚úÖ Android –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∏ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è
- ‚úÖ JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ
- ‚úÖ Backend —Ä–æ—É—Ç—ã —Å–æ–∑–¥–∞–Ω—ã –≤ `backend/src/routes/auth.ts`
- ‚è≥ Backend –µ—â–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å –Ω–æ–≤—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏

## –®–∞–≥–∏ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ 185.177.216.22

### 1. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É
```bash
ssh root@185.177.216.22
```

### 2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
```bash
cd /var/www/my-vintage-shop
# –∏–ª–∏ –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤–∞—à backend
```

### 3. –û–±–Ω–æ–≤–∏—Ç–µ –∫–æ–¥ –∏–∑ Git
```bash
git pull origin main
```

### 4. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–æ–≤—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
```bash
cd backend
npm install
```

–ù–æ–≤—ã–µ –ø–∞–∫–µ—Ç—ã:
- `jsonwebtoken` - –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ JWT —Ç–æ–∫–µ–Ω–æ–≤
- `bcryptjs` - –¥–ª—è —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä–æ–ª–µ–π
- `@types/jsonwebtoken` –∏ `@types/bcryptjs` - —Ç–∏–ø—ã TypeScript

### 5. –û–±–Ω–æ–≤–∏—Ç–µ .env —Ñ–∞–π–ª
–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è JWT —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞:

```bash
nano backend/.env
```

–î–æ–±–∞–≤—å—Ç–µ —Å—Ç—Ä–æ–∫—É:
```
JWT_SECRET=–≤–∞—à-–æ—á–µ–Ω—å-–¥–ª–∏–Ω–Ω—ã–π-–∏-—Å–ª–æ–∂–Ω—ã–π-—Å–µ–∫—Ä–µ—Ç–Ω—ã–π-–∫–ª—é—á-–º–∏–Ω–∏–º—É–º-32-—Å–∏–º–≤–æ–ª–∞
```

–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –∫–ª—é—á –º–æ–∂–Ω–æ —Ç–∞–∫:
```bash
node -e "console.log(require('crypto').randomBytes(64).toString('hex'))"
```

### 6. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
```bash
npx prisma migrate dev --name add_jwt_auth
```

–≠—Ç–æ —Å–æ–∑–¥–∞—Å—Ç:
- –ù–æ–≤—ã–µ –ø–æ–ª—è –≤ —Ç–∞–±–ª–∏—Ü–µ User: `email`, `password` (–æ–±–∞ nullable –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å Telegram users)
- –ù–æ–≤—É—é —Ç–∞–±–ª–∏—Ü–∏—é `RefreshToken` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è refresh —Ç–æ–∫–µ–Ω–æ–≤

### 7. –ü–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ backend
```bash
npm run build
```

### 8. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ backend —Å–µ—Ä–≤–∏—Å
–ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ PM2:
```bash
pm2 restart backend
# –∏–ª–∏
pm2 restart all
```

–ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ systemd:
```bash
systemctl restart vintage-shop-backend
```

### 9. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —Å–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç
```bash
curl http://localhost:3002/api/products
```

–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å JSON —Å —Ç–æ–≤–∞—Ä–∞–º–∏ –∏–ª–∏ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤.

## –ü—Ä–æ–≤–µ—Ä–∫–∞ JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

### –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```bash
curl -X POST http://185.177.216.22:3002/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "Test1234",
    "name": "Test User"
  }'
```

–î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å:
```json
{
  "success": true,
  "data": {
    "user": {
      "id": 1,
      "email": "test@example.com",
      "name": "Test User",
      "role": "user",
      "isVerified": false
    },
    "accessToken": "eyJhbG...",
    "refreshToken": "eyJhbG..."
  }
}
```

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏–Ω
```bash
curl -X POST http://185.177.216.22:3002/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "Test1234"
  }'
```

## –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

–°—Ç–∞—Ä—ã–µ Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ **–ø—Ä–æ–¥–æ–ª–∂–∞—Ç —Ä–∞–±–æ—Ç–∞—Ç—å**! –û–Ω–∏:
- –ò–º–µ—é—Ç `telegramId` (–Ω–µ null)
- –ù–µ –∏–º–µ—é—Ç `email` –∏ `password` (null)
- –ú–æ–≥—É—Ç –≤–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram Mini App (–µ—Å–ª–∏ –æ–Ω–æ –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)

–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —á–µ—Ä–µ–∑ Android app:
- –ò–º–µ—é—Ç `email` –∏ `password` (–Ω–µ null)
- –ú–æ–≥—É—Ç –Ω–µ –∏–º–µ—Ç—å `telegramId` (null)
- –í—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é

## Troubleshooting

### –û—à–∏–±–∫–∞ "Database connection failed"
–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ PostgreSQL –∑–∞–ø—É—â–µ–Ω:
```bash
systemctl status postgresql
```

### –û—à–∏–±–∫–∞ "JWT_SECRET not defined"
–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –¥–æ–±–∞–≤–∏–ª–∏ `JWT_SECRET` –≤ `backend/.env`

### –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "Failed to fetch"
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ backend –∑–∞–ø—É—â–µ–Ω: `pm2 status`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `pm2 logs backend`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å: `curl http://185.177.216.22:3002/api/products`

### Prisma migration –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–∞—é—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã, –º–æ–∂–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å –±–∞–∑—É (–í–ù–ò–ú–ê–ù–ò–ï: —É–¥–∞–ª–∏—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ):
```bash
npx prisma migrate reset
```

–ò–ª–∏ —Å–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –≤—Ä—É—á–Ω—É—é –≤ SQL.

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ backend:

1. **–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ Android —ç–º—É–ª—è—Ç–æ—Ä–µ**
2. **–ù–∞–∂–º–∏—Ç–µ "–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç"**
3. **–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏**
4. **–ü–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–π–¥–µ—Ç–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ**
5. **–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (–Ω—É–∂–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ä–æ–ª—å—é admin)**

–ß—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–¥–º–∏–Ω–æ–º:
```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –ë–î
npx prisma studio
# –ò–ª–∏ —á–µ—Ä–µ–∑ SQL
psql -U your_db_user -d your_db_name -c "UPDATE \"User\" SET role = 'admin' WHERE email = 'test@example.com';"
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

–í—Å–µ JWT —Ñ–∞–π–ª—ã —É–∂–µ —Å–æ–∑–¥–∞–Ω—ã:

```
backend/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ auth.ts              # POST /register, /login, /refresh, /logout
‚îÇ   ‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ jwtAuth.ts           # JWT –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö —Ä–æ—É—Ç–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ jwt.ts               # generateAccessToken(), verifyToken()
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ bcrypt.ts            # hashPassword(), comparePassword()
‚îÇ   ‚îî‚îÄ‚îÄ server.ts                # app.use('/api/auth', authRoutes)
```

–í—Å–µ –≥–æ—Ç–æ–≤–æ –∫ –∑–∞–ø—É—Å–∫—É! üöÄ
