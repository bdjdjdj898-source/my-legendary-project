#cloud-config

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
package_update: true
package_upgrade: true

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
packages:
  - curl
  - wget
  - git
  - nginx
  - ufw
  - htop
  - unzip
  - software-properties-common
  - apt-transport-https
  - ca-certificates
  - gnupg
  - lsb-release

# –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –¥–µ–ø–ª–æ—è
users:
  - name: deploy
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2E... # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à SSH –∫–ª—é—á

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∞–π—Ä–≤–æ–ª–∞
runcmd:
  # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js 18.x
  - curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
  - apt-get install -y nodejs

  # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker
  - curl -fsSL https://get.docker.com -o get-docker.sh
  - sh get-docker.sh
  - usermod -aG docker deploy
  - usermod -aG docker ubuntu

  # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker Compose
  - curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
  - chmod +x /usr/local/bin/docker-compose

  # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ UFW (—Ñ–∞–π—Ä–≤–æ–ª)
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow ssh
  - ufw allow 80/tcp
  - ufw allow 443/tcp
  - ufw allow 3000/tcp
  - ufw --force enable

  # –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞
  - mkdir -p /var/www/vintage-shop
  - chown deploy:deploy /var/www/vintage-shop

  # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
  - apt-get install -y unattended-upgrades
  - echo 'Unattended-Upgrade::Automatic-Reboot "false";' >> /etc/apt/apt.conf.d/50unattended-upgrades

  # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ swap (–µ—Å–ª–∏ RAM < 2GB)
  - fallocate -l 2G /swapfile
  - chmod 600 /swapfile
  - mkswap /swapfile
  - swapon /swapfile
  - echo '/swapfile none swap sw 0 0' >> /etc/fstab

  # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ Let's Encrypt
  - apt-get install -y certbot python3-certbot-nginx

# –§–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
write_files:
  # Nginx –∫–æ–Ω—Ñ–∏–≥ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞
  - path: /etc/nginx/sites-available/vintage-shop
    content: |
      server {
          listen 80;
          server_name –≤–∞—à-–¥–æ–º–µ–Ω.com www.–≤–∞—à-–¥–æ–º–µ–Ω.com;

          location / {
              proxy_pass http://localhost:3000;
              proxy_http_version 1.1;
              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Connection 'upgrade';
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
              proxy_cache_bypass $http_upgrade;
          }
      }
    owner: root:root
    permissions: '0644'

  # Systemd —Å–µ—Ä–≤–∏—Å –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  - path: /etc/systemd/system/vintage-shop.service
    content: |
      [Unit]
      Description=Vintage Shop Telegram WebApp
      After=network.target

      [Service]
      Type=simple
      User=deploy
      WorkingDirectory=/var/www/vintage-shop
      ExecStart=/usr/bin/npm start
      Restart=always
      RestartSec=10
      Environment=NODE_ENV=production

      [Install]
      WantedBy=multi-user.target
    owner: root:root
    permissions: '0644'

  # –°–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è
  - path: /home/deploy/deploy.sh
    content: |
      #!/bin/bash
      set -e

      cd /var/www/vintage-shop

      echo "üîÑ Pulling latest changes..."
      git pull origin main

      echo "üì¶ Installing dependencies..."
      npm install --production

      echo "üèóÔ∏è Building application..."
      npm run build

      echo "üóÑÔ∏è Running database migrations..."
      npm run db:migrate

      echo "üîÑ Restarting service..."
      sudo systemctl restart vintage-shop

      echo "‚úÖ Deployment completed!"
    owner: deploy:deploy
    permissions: '0755'

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ –≤ –∫–æ–Ω—Ü–µ
final_message: |
  ==========================================
  üéâ –°–µ—Ä–≤–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!

  –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:
  1. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å: ssh deploy@–≤–∞—à-ip
  2. –°–∫–ª–æ–Ω–∏—Ä—É–π—Ç–µ –ø—Ä–æ–µ–∫—Ç –≤ /var/www/vintage-shop
  3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ .env —Ñ–∞–π–ª
  4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: ./deploy.sh
  ==========================================